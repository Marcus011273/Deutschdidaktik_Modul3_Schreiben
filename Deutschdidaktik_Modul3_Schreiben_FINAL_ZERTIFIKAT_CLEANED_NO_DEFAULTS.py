FRAGENPOOL = [
    {
        "id": "m3_1",
        "typ": "single_choice",
        "frage": "Welches Ziel wird dem Schreiben laut K. Metzger nicht zugeordnet?",
        "optionen": [
            "Kognitive F√∂rderung",
            "Objektivierung von Gedanken",
            "F√∂rderung sportlicher Aktivit√§t",
            "Grundlage beruflicher Bildung"
        ],
        "antwort": "F√∂rderung sportlicher Aktivit√§t",
        "gewichtung": 1
    },
    {
        "id": "m3_2",
        "typ": "zuordnung",
        "frage": "Ordne den Formen des Schreibens passende Beispiele zu.",
        "paare": [
            [
                "Erz√§hlendes Schreiben",
                [
                    "Die aufregendsten 60 Minuten‚Ä¶",
                    "Beruf des Schaustellers",
                    "Familientag muss sein!"
                ]
            ],
            [
                "Informierendes Schreiben",
                [
                    "Beruf des Schaustellers",
                    "Familientag muss sein!",
                    "Die aufregendsten 60 Minuten‚Ä¶"
                ]
            ],
            [
                "Argumentierendes Schreiben",
                [
                    "Familientag muss sein!",
                    "Beruf des Schaustellers",
                    "Die aufregendsten 60 Minuten‚Ä¶"
                ]
            ]
        ],
        "antworten": [
            "Die aufregendsten 60 Minuten‚Ä¶",
            "Beruf des Schaustellers",
            "Familientag muss sein!"
        ],
        "gewichtung": 2
    },
    {
        "id": "m3_3",
        "typ": "szenario",
        "frage": "Ein Sch√ºler schreibt einen Text mit wenig Struktur und ohne klares Ziel. Was sollte laut LehrplanPLUS gezielt gef√∂rdert werden?",
        "optionen": [
            "Handgeschicklichkeit",
            "Text√ºberarbeitung mit Textlupe",
            "Strategien der Schreibplanung",
            "Lautes Vorlesen"
        ],
        "antwort": "Strategien der Schreibplanung",
        "gewichtung": 1
    },
    {
        "id": "m3_4",
        "typ": "multi_select",
        "frage": "Welche Elemente geh√∂ren laut Pr√§sentation zur expliziten Schreibstrategie-Vermittlung?",
        "optionen": [
            "Cluster",
            "Mindmap",
            "Interpretationsaufsatz",
            "Wortspeicher"
        ],
        "antworten": [
            "Cluster",
            "Mindmap",
            "Wortspeicher"
        ],
        "gewichtung": 1
    },
    {
        "id": "m3_5",
        "typ": "offen",
        "frage": "Warum ist der Begriff 'Aufsatz' laut Pr√§sentation nicht mehr zeitgem√§√ü?",
        "gewichtung": 2
    },
    {
        "id": "m3_6",
        "typ": "single_choice",
        "frage": "Welcher Aspekt geh√∂rt nicht zur Definition guter Schreibaufgaben?",
        "optionen": [
            "Konkreter Adressat",
            "Unmittelbarer Alltagsbezug",
            "M√ºndliche Kommunikation als Ziel",
            "Schreibziel bewusst machen"
        ],
        "antwort": "M√ºndliche Kommunikation als Ziel",
        "gewichtung": 1
    },
    {
        "id": "m3_7",
        "typ": "szenario",
        "frage": "Eine Sch√ºlerin nutzt beim Schreiben W-Fragen, Cluster und Mindmaps. Welche Phase wird hier angesprochen?",
        "optionen": [
            "√úberarbeitung",
            "Planung",
            "Bewertung",
            "Reflexion"
        ],
        "antwort": "Planung",
        "gewichtung": 1
    },
    {
        "id": "m3_8",
        "typ": "szenario",
        "frage": "Eine Klasse hat ihre ersten Textentw√ºrfe verfasst. Die Lehrkraft gibt gezielte Hinweise zu Satzbau, Wortwahl und Textstruktur. In welcher Phase des Schreibprozesses befinden sich die Sch√ºlerinnen und Sch√ºler?",
        "optionen": [
            "Planung",
            "√úberarbeitung",
            "Schreibfluss",
            "Reflexion"
        ],
        "antwort": "√úberarbeitung",
        "gewichtung": 1
    },
    {
        "id": "m3_9",
        "typ": "zuordnung",
        "frage": "Ordne den Aussagen jeweils die passende Qualit√§t guter Schreibaufgaben zu:",
        "paare": [
            [
                "Die Aufgabe soll einen klaren Zweck verfolgen.",
                [
                    "Zielklarheit",
                    "Alltagsbezug",
                    "Adressatenbezug"
                ]
            ],
            [
                "Die Aufgabe geht von realit√§tsnahen Situationen aus.",
                [
                    "Alltagsbezug",
                    "Zielklarheit",
                    "Adressatenbezug"
                ]
            ],
            [
                "Die Sch√ºlerinnen und Sch√ºler sollen den Leser kennen.",
                [
                    "Adressatenbezug",
                    "Alltagsbezug",
                    "Zielklarheit"
                ]
            ]
        ],
        "antworten": [
            "Zielklarheit",
            "Alltagsbezug",
            "Adressatenbezug"
        ],
        "gewichtung": 2
    },
    {
        "id": "m3_10",
        "typ": "offen",
        "frage": "Was ist das Ziel der Schreibkonferenz im Unterricht?",
        "gewichtung": 2
    },
    {
        "id": "m3_11",
        "typ": "multi_select",
        "frage": "Welche Aussagen treffen auf einen vollst√§ndigen Schreibprozess im Unterricht zu?",
        "optionen": [
            "Schreiben beginnt erst, wenn der Text fertig ist",
            "Reflexion geh√∂rt zum Schreiben",
            "√úberarbeitung erfolgt idealerweise mehrstufig",
            "Der Schreibprozess besteht nur aus der Planungsphase"
        ],
        "antworten": [
            "Reflexion geh√∂rt zum Schreiben",
            "√úberarbeitung erfolgt idealerweise mehrstufig"
        ],
        "gewichtung": 1
    },
    {
        "id": "m3_12",
        "typ": "single_choice",
        "frage": "Welche Aussage beschreibt laut Pr√§sentation die Rolle der Lehrkraft im Schreibunterricht am besten?",
        "optionen": [
            "Die Lehrkraft bewertet vor allem Rechtschreibung",
            "Die Lehrkraft ist Coach im Schreibprozess",
            "Die Lehrkraft bleibt w√§hrend des Schreibens passiv",
            "Die Lehrkraft schreibt die Texte f√ºr die Sch√ºler vor"
        ],
        "antwort": "Die Lehrkraft ist Coach im Schreibprozess",
        "gewichtung": 1
    },
    {
        "id": "m3_13",
        "typ": "zuordnung",
        "frage": "Ordne die Hilfsmittel ihrer Funktion im Schreibprozess zu:",
        "paare": [
            [
                "Textlupe",
                [
                    "Sprache untersuchen",
                    "Ideen strukturieren",
                    "Reflexion"
                ]
            ],
            [
                "Schreibkarussell",
                [
                    "Reflexion",
                    "Sprache untersuchen",
                    "Struktur"
                ]
            ],
            [
                "Mindmap",
                [
                    "Ideen strukturieren",
                    "Rechtschreibung",
                    "√úberarbeitung"
                ]
            ]
        ],
        "antworten": [
            "Sprache untersuchen",
            "Reflexion",
            "Ideen strukturieren"
        ],
        "gewichtung": 2
    },
    {
        "id": "m3_14",
        "typ": "offen",
        "frage": "Wie k√∂nnen Schreibaufgaben gestaltet sein, damit sie unterschiedliche Lernvoraussetzungen ber√ºcksichtigen?",
        "gewichtung": 2
    }
]

def bewerte_freitext_antwort(text, max_punkte):
    laenge = len(text.strip())
    if laenge >= 150:
        return max_punkte
    elif 100 <= laenge < 150:
        return round(max_punkte / 2)
    else:
        return 0


import streamlit as st
import random
import json
import os
from datetime import datetime
from fpdf import FPDF

# === KONFIGURATION ===
st.set_page_config(page_title="Interaktiver Test ‚Äì Modul 3", page_icon="üìù")
st.title("üìù Interaktiver Test zu Modul 3: Schreiben")



# Hinweis: Funktionaler Teil (Fortschritt, Anzeige, Bewertung, Zertifikat) folgt im n√§chsten Teil des Skripts

# === FORTSCHRITT & ANTWORTSPEICHERUNG ===
ANTWORT_DATEI = "antworten_{user}.json"
FORTSCHRITT_DATEI = "fortschritt_{user}.json"

def lade_fortschritt(user):
    pfad = FORTSCHRITT_DATEI.format(user=user.replace(" ", "_"))
    if os.path.exists(pfad):
        with open(pfad, "r", encoding="utf-8") as f:
            return json.load(f)
    return {"seite": 0, "punkte": 0, "beantwortet": [], "offene_antworten": []}

def speichere_fortschritt(user, daten):
    pfad = FORTSCHRITT_DATEI.format(user=user.replace(" ", "_"))
    with open(pfad, "w", encoding="utf-8") as f:
        json.dump(daten, f, indent=2, ensure_ascii=False)

def speichere_offene_antwort(user, frage_id, antworttext):
    pfad = ANTWORT_DATEI.format(user=user.replace(" ", "_"))
    daten = []
    if os.path.exists(pfad):
        with open(pfad, "r", encoding="utf-8") as f:
            daten = json.load(f)
    daten.append({"frage_id": frage_id, "antwort": antworttext, "zeit": datetime.now().strftime('%Y-%m-%d %H:%M')})
    with open(pfad, "w", encoding="utf-8") as f:
        json.dump(daten, f, indent=2, ensure_ascii=False)

# === ZERTIFIKAT-KLASSE ===
class ZertifikatPDF(FPDF):
    def header(self):
        self.set_fill_color(240, 248, 255)
        self.rect(10, 10, 190, 277, 'F')
        self.set_draw_color(70, 70, 160)
        self.set_line_width(1)
        self.rect(10, 10, 190, 277)
        self.set_font("Arial", "B", 28)
        self.set_text_color(40, 40, 100)
        self.ln(20)
        self.cell(0, 20, "Zertifikat Modul 3: Schreiben", ln=True, align='C')
        self.ln(5)
        self.set_font("Arial", "I", 14)
        self.set_text_color(80, 80, 80)
        self.cell(0, 10, "f√ºr besondere Leistungen im Kompetenzbereich Schreiben", ln=True, align='C')
        self.ln(10)

    def footer(self):
        self.set_y(-40)
        self.set_font("Arial", "I", 12)
        self.set_text_color(60, 60, 60)
        self.cell(0, 10, "Dozent:innen: Marcus M√ºller, Christiane Riehn-Wild", ln=True, align='C')
        self.set_font("Arial", "I", 10)
        self.cell(0, 10, "Modul 3 - Interaktiver Test zum Kompetenzbereich Schreiben", 0, 0, 'C')

    def zertifikat_content(self, name, punkte, max_punkte, datum):
        if punkte >= 16:
            bewertung = "mit herausragendem Erfolg"
        elif punkte >= 12:
            bewertung = "mit gutem Erfolg"
        elif punkte >= 7:
            bewertung = "mit Erfolg"
        else:
            bewertung = "mit wenig Erfolg"

        self.set_y(90)
        self.set_font("Arial", "", 16)
        self.set_text_color(0, 0, 0)
        text = f"""Hiermit wird best√§tigt, dass

{name}

am interaktiven Test
'Modul 3: Kompetenzbereich Schreiben'
{bewertung} teilgenommen hat."""
        self.multi_cell(0, 10, text, align='C')
        self.ln(10)
        self.set_font("Arial", "B", 14)
        self.cell(0, 10, f"Punktzahl: {punkte} / {max_punkte}", ln=True, align='C')
        self.cell(0, 10, f"Datum: {datum}", ln=True, align='C')
# Hinweis: Die restliche Interaktionslogik (Fragenanzeige & Adminbereich) folgt hier im Live-Skript
# Sie wurde bereits vorher im Projekt entwickelt und kann direkt erg√§nzt werden.

# === START TEST ===
user = st.text_input("Bitte gib deinen vollst√§ndigen Namen ein:")

if user:
    if "fortschritt" not in st.session_state:
        st.session_state.fortschritt = lade_fortschritt(user)
        st.session_state.fragenliste = FRAGENPOOL
        random.shuffle(st.session_state.fragenliste)
        st.session_state.user = user

    fortschritt = st.session_state.fortschritt
    fragenliste = st.session_state.fragenliste
    seite = fortschritt["seite"]

    if seite >= len(fragenliste):
        st.success("üéâ Du hast den Test abgeschlossen!")
        st.info(f"Erreichte Punktzahl: {fortschritt['punkte']} von {sum(f['gewichtung'] for f in fragenliste)}")
        if st.button("üìÑ Zertifikat erstellen"):
            cert = ZertifikatPDF()
            cert.add_page()
            cert.zertifikat_content(user, fortschritt["punkte"], sum(f["gewichtung"] for f in fragenliste), datetime.now().strftime('%d.%m.%Y'))
            filename = f"zertifikat_{user.replace(' ', '_')}.pdf"
            cert.output(filename)
            with open(filename, "rb") as file:
                st.download_button("Zertifikat herunterladen", file, file_name=filename)
    else:
        frage = fragenliste[seite]
        st.subheader(f"Frage {seite + 1} von {len(fragenliste)}")
        st.write(f"**{frage['frage']}**")

        key_base = f"{frage['id']}_{seite}"
        if f"antwort_bestaetigt_{key_base}" not in st.session_state:
            st.session_state[f"antwort_bestaetigt_{key_base}"] = False
            st.session_state[f"antwort_korrekt_{key_base}"] = False

        antwort_bestaetigt = st.session_state[f"antwort_bestaetigt_{key_base}"]

        if not antwort_bestaetigt:
            if frage["typ"] == "single_choice":
                auswahl = st.radio("Bitte ausw√§hlen:", frage["optionen"], key=f"{key_base}_radio")
                if st.button("Antwort best√§tigen", key=f"btn_{key_base}"):
                    if auswahl == frage["antwort"]:
                        st.success("‚úÖ Richtig!")
                        st.session_state[f"antwort_korrekt_{key_base}"] = True
                    else:
                        st.error("‚ùå Falsch.")
                        st.info(f"‚úÖ Richtige Antwort: **{frage['antwort']}**")
                    st.session_state[f"antwort_bestaetigt_{key_base}"] = True

            elif frage["typ"] == "multi_select":
                auswahl = st.multiselect("W√§hle alle zutreffenden Optionen:", frage["optionen"], default=[], key=f"{key_base}_multi")
                if st.button("Antwort best√§tigen", key=f"btn_{key_base}"):
                    if set(auswahl) == set(frage["antworten"]):
                        st.success("‚úÖ Richtig!")
                        st.session_state[f"antwort_korrekt_{key_base}"] = True
                    else:
                        st.error("‚ùå Nicht korrekt.")
                        st.info(f"‚úÖ Richtige Antworten: **{', '.join(frage['antworten'])}**")
                    st.session_state[f"antwort_bestaetigt_{key_base}"] = True

            elif frage["typ"] == "zuordnung":
                antworten = []
                for i, (frage_text, optionen) in enumerate(frage["paare"]):
                    antworten.append(st.selectbox(frage_text, [""] + optionen, key=f"{key_base}_{i}"))
                if st.button("Antwort best√§tigen", key=f"btn_{key_base}"):
                    if antworten == frage["antworten"]:
                        st.success("‚úÖ Richtig zugeordnet!")
                        st.session_state[f"antwort_korrekt_{key_base}"] = True
                    else:
                        st.error("‚ùå Falsch zugeordnet.")
                        st.info(f"‚úÖ Richtige Zuordnung: **{', '.join(frage['antworten'])}**")
                    st.session_state[f"antwort_bestaetigt_{key_base}"] = True

            elif frage["typ"] == "szenario":
                auswahl = st.radio("W√§hle die beste Ma√ünahme:", frage["optionen"], key=f"{key_base}_radio")
                if st.button("Antwort best√§tigen", key=f"btn_{key_base}"):
                    if auswahl == frage["antwort"]:
                        st.success("‚úÖ Richtig!")
                        st.session_state[f"antwort_korrekt_{key_base}"] = True
                    else:
                        st.error("‚ùå Nicht korrekt.")
                        st.info(f"‚úÖ Richtige Antwort: **{frage['antwort']}**")
                    st.session_state[f"antwort_bestaetigt_{key_base}"] = True

            
            
            elif frage["typ"] == "offen":
                eingabe = st.text_area("Deine Antwort:", key=f"{key_base}_text")
                if st.button("Antwort speichern", key=f"btn_{key_base}"):
                    if eingabe.strip():
                        speichere_offene_antwort(user, frage["id"], eingabe.strip())
                        punkte = bewerte_freitext_antwort(eingabe.strip(), frage["gewichtung"])
                        if punkte > 0:
                            st.success(f"Antwort gespeichert und mit {punkte} Punkt(en) bewertet.")
                            fortschritt["punkte"] += punkte
                        else:
                            st.warning("Antwort zu kurz ‚Äì keine Punkte vergeben.")
                        speichere_fortschritt(user, fortschritt)
                        st.session_state[f"antwort_korrekt_{key_base}"] = True
                        st.session_state[f"antwort_bestaetigt_{key_base}"] = True
                    else:
                        st.warning("Bitte gib eine Antwort ein.")

                elif st.session_state.get(f"antwort_bestaetigt_{key_base}", False):
                    if st.button("‚û°Ô∏è Weiter zur n√§chsten Frage", key=f"weiter_{key_base}"):
                        fortschritt["seite"] += 1
                        speichere_fortschritt(user, fortschritt)
                        st.session_state.pop(f"antwort_bestaetigt_{key_base}", None)
                        st.session_state.pop(f"antwort_korrekt_{key_base}", None)
                        st.rerun()



        else:
            if st.button("‚û°Ô∏è Weiter zur n√§chsten Frage", key=f"weiter_{key_base}"):
                if st.session_state[f"antwort_korrekt_{key_base}"] and frage["typ"] != "offen":
                    fortschritt["punkte"] += frage["gewichtung"]
                fortschritt["seite"] += 1
                speichere_fortschritt(user, fortschritt)
                st.session_state.pop(f"antwort_bestaetigt_{key_base}", None)
                st.session_state.pop(f"antwort_korrekt_{key_base}", None)
                st.rerun()

# === ADMINBEREICH (mit Passwortschutz) ===
import glob

st.sidebar.title("üîê Adminbereich")

admin_pass = st.sidebar.text_input("Passwort eingeben:", type="password")

if admin_pass == "Modul3":  # Passwort hier setzen
    if st.sidebar.checkbox("Offene Antworten anzeigen"):
        user_files = [f for f in os.listdir() if f.startswith("antworten_") and f.endswith(".json")]
        for file in user_files:
            st.sidebar.markdown(f"### üßë {file.replace('antworten_', '').replace('.json', '')}")
            with open(file, "r", encoding="utf-8") as f:
                daten = json.load(f)
            for eintrag in daten:
                st.sidebar.markdown(f"**{eintrag['frage_id']}** ({eintrag['zeit']}):")
                st.sidebar.code(eintrag['antwort'])

    if st.sidebar.checkbox("Punktest√§nde anzeigen"):
        fortschritt_files = [f for f in os.listdir() if f.startswith("fortschritt_") and f.endswith(".json")]
        for file in fortschritt_files:
            name = file.replace("fortschritt_", "").replace(".json", "")
            with open(file, "r", encoding="utf-8") as f:
                data = json.load(f)
            st.sidebar.write(f"{name}: {data['punkte']} Punkte, Frage {data['seite']}")

    if st.sidebar.button("üö® Alle Nutzerergebnisse l√∂schen"):
        geloescht = 0
        for file in glob.glob("antworten_*.json") + glob.glob("fortschritt_*.json"):
            try:
                os.remove(file)
                geloescht += 1
            except:
                pass
        st.sidebar.success(f"{geloescht} Dateien wurden gel√∂scht. Alle Nutzerergebnisse zur√ºckgesetzt.")


   



     
           
            
        
                     
              
   
 
